<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity4"
	layout:decorator="fragments/template">
<head lang="it">
</head>
<body>
	<div layout:fragment="content" id="main-container" th:fragment="content">
		<div class="row">
			<div class="col-xs-12">
				<div class="x_panel">
					<div class="x_title">
						<h2 th:text="#{label.composizione_comunicazione}">label.composizione_comunicazione</h2>
						<div class="pull-right buttons-header">
							<label class="btn btn-success pull-right" for="submitButton"><i class="fa fa-paper-plane"></i> <span class="white" th:text="#{label.invia}"></span></label>
							<a class="btn btn-primary pull-right" th:text="#{label.indietro}" th:href="@{|/comunicazione/dashboard|}"></a>
						</div>
						<div class="clearfix"></div>
					</div>

					<div class="x_content">
						<form
							id="formComunicazione" class="form-horizontal form-label-left"
							th:action="@{/comunicazione/send}"
							method="post" enctype="multipart/form-data"
							novalidate="novalidate">

							<input type="hidden" name="editId" th:value="${comunicazioneWrapper.comunicazione.id}" />
							<input type="hidden" th:field="${comunicazioneWrapper.comunicazione.mittente}" />
							<input type="hidden" th:field="${comunicazioneWrapper.ambitoList}" />
							<input type="hidden" th:field="${comunicazioneWrapper.tipologiaList}" />

							<div class="header row">
								<div class="header-comunicazione col-lg-6 col-md-6 col-sm-12 col-xs-12">
									<div class="mittente-container item form-group">
										<div class="col-sm-2 col-xs-2 text-right">
											<label class="control-label" th:text="#{label.from}"></label>
										</div>
										<div class="col-xs-12 col-sm-10">
											<div class="fixed-value">
												<div class="comunicazione-input" th:text="${comunicazioneWrapper.comunicazione.mittente.username} + ' &lt;' + ${comunicazioneWrapper.comunicazione.mittente.email} + '&gt;' "></div>
											</div>
										</div>
									</div>

									<div th:if="${comunicazioneWrapper.comunicazione.mittente.isSegreteria()}" class="filter-destinatari-container item form-group">
										<div class="col-sm-2 col-xs-2 text-right">
											<label class="control-label" th:text="#{label.filtri}"></label>
										</div>
										<div class="col-xs-12 col-sm-10">
											<select class="selectpicker" multiple="multiple"
												data-width="100%" data-style="btn-info"
												data-size="10" data-hide-disabled="false"
												id="filterSelect" onchange="showHideDestinatari($(this).val())"
												title="Nessun filtro">
												<option th:text="#{label.commissione}"></option>
												<option th:text="#{label.osservatori}"></option>
												<option th:text="#{label.provider}"></option>
												<option th:text="#{label.referee_ecm}"></option>
											</select>
										</div>
									</div>

									<div class="destinatari-container item comunicazioneAlert form-group" th:classappend="${#fields.hasErrors('comunicazioneWrapper.comunicazione.destinatari')} ? 'bad-remade'">
										<div class="col-sm-2 col-xs-2 text-right">
											<label class="control-label" th:text="#{label.to}"></label>
										</div>
										<div class="col-xs-12 col-sm-10">
											<select th:if="${comunicazioneWrapper.comunicazione.mittente.isSegreteria()}" id="destinatari" class="comunicazione-input select2_multiple" multiple="multiple"
												data-width="100%"
												th:field="${comunicazioneWrapper.comunicazione.destinatari}"
												data-size="10" title="Seleziona destinatari..."
												onchange="removeAlerts()"
												th:remove="all-but-first">
											</select>
											<div class="fixed-value" th:unless="${comunicazioneWrapper.comunicazione.mittente.isSegreteria()}"
												th:text="#{label.segreteria_ecm} + ' &lt;' + #{label.segreteria_ecm_mail} + '&gt;' ">
											</div>
											<div th:if="${#fields.hasErrors('comunicazioneWrapper.comunicazione.destinatari')}" class="alert" th:errors="${comunicazioneWrapper.comunicazione.destinatari}"></div>
										</div>
									</div>

									<div class="oggetto-container item comunicazioneAlert form-group" th:classappend="${#fields.hasErrors('comunicazioneWrapper.comunicazione.oggetto')} ? 'bad'">
										<div class="col-sm-2 col-xs-2 text-right">
											<label class="control-label" th:text="#{label.oggetto}"></label>
										</div>
										<div class="col-xs-12 col-sm-10">
											<div class="no-padding">
												<input th:field="${comunicazioneWrapper.comunicazione.oggetto}" type="text"
													class="form-control comunicazione-input"/>
											</div>
											<div th:if="${#fields.hasErrors('comunicazioneWrapper.comunicazione.oggetto')}" class="alert" th:errors="${comunicazioneWrapper.comunicazione.oggetto}"></div>
										</div>
									</div>
								</div>

								<div class="subheader-comunicazione col-lg-6 col-md-6 col-sm-12 col-xs-12">
									<div class="ambito-container item comunicazioneAlert form-group" th:classappend="${#fields.hasErrors('comunicazioneWrapper.comunicazione.ambito')} ? 'bad'">
										<div class="col-sm-5 col-xs-2 text-right">
											<label class="control-label" th:text="#{label.ambito}"></label>
										</div>
										<div class="col-xs-12 col-sm-7">
											<div class="no-padding">
												<select
													class="selectpicker"
													th:field="${comunicazioneWrapper.comunicazione.ambito}"
													data-width="100%" data-style="btn-primary"
													data-actions-box="true" data-size="10"
													data-hide-disabled="false"
													id="ambitoSelect" onchange="abilitaTipologia();"
													title="Seleziona un ambito...">
													<option
														th:each="ambito, row: ${comunicazioneWrapper.ambitoList}"
														th:value="${ambito}"
														th:text="${ambito.nome}">
													</option>
												</select>
											</div>
											<div th:if="${#fields.hasErrors('comunicazioneWrapper.comunicazione.ambito')}" class="alert" th:errors="${comunicazioneWrapper.comunicazione.ambito}"></div>
										</div>
									</div>

									<div class="tipologia-container item comunicazioneAlert form-group" th:classappend="${#fields.hasErrors('comunicazioneWrapper.comunicazione.tipologia')} ? 'bad'">
										<div class="col-sm-5 col-xs-2 text-right">
											<label class="control-label" th:text="#{label.tipologia}"></label>
										</div>
										<div class="col-xs-12 col-sm-7">
											<div class="no-padding">
												<select
													class="selectpicker"
													th:field="${comunicazioneWrapper.comunicazione.tipologia}"
													data-width="100%" data-style="btn-primary"
													data-actions-box="true" data-size="10"
													data-hide-disabled="false"
													th:disabled="${comunicazioneWrapper.comunicazione.ambito == null}"
													id="tipologiaSelect"
													title="Seleziona una tipologia...">
													<option
														th:each="tipo, row: ${comunicazioneWrapper.tipologiaList}"
														th:value="${tipo}"
														th:text="${tipo.nome}"
														th:name="${tipo.ambito}">
													</option>
												</select>
												<div th:if="${#fields.hasErrors('comunicazioneWrapper.comunicazione.tipologia')}" class="alert" th:errors="${comunicazioneWrapper.comunicazione.tipologia}"></div>
											</div>
										</div>
									</div>
								</div>
							</div>

							<div class="divider"></div>

							<div class="comunicazione-content row">
								<div class="col-xs-12">
									<textarea class="comunicazione-testo" th:field="${comunicazioneWrapper.comunicazione.messaggio}"></textarea>
								</div>

								<th:block th:include="fragments/allegati :: allegati(comunicazioneWrapper, false, allegatoComunicazione, null, null, null, false, null, false)" ></th:block>
							</div>

							<input id="submitButton" type="submit" style="display: none;" />

						</form>

					</div>
				</div>
			</div>
			<script th:inline="javascript">
			/*<![CDATA[*/

				$(document).ready(function() {
					$(".select2_multiple").select2({
				    	placeholder: "Seleziona destinatari",
				    	allowClear: true
				    });

					$(".tipologia-container").on("hidden.bs.select", function() {
						$(this).removeClass('bad').find('div.alert').fadeOut(150, function() {
							$(this).remove();
						});
					});

					$(".ambito-container").on("changed.bs.select", function() {
						abilitaTipologia();
					});

					$(".ambito-container").on("hidden.bs.select", function() {
						$(this).removeClass('bad').find('div.alert').fadeOut(150, function() {
							$(this).remove();
						});
					});

					if([[${comunicazioneWrapper.comunicazione.ambito}]]) {
						initTipologia();
					}

					showHideDestinatari(null);

				});

				var allDestinatari = JSON.parse([[${comunicazioneWrapper.destinatariJSON}]]);

				function removeAlerts() {
					$(".destinatari-container").removeClass('bad-remade').find('div.alert').fadeOut(150, function() {
						$(this).remove();
					});
				}

				//abilita le tipologia al change dell'ambito
				function abilitaTipologia(){
					// abilita la select della tipologia
					$("#tipologiaSelect").prop("disabled", false);
					// cicla le tipologie mostrando quelle relative all'ambito e nascondendo le altre
					$.each($("#tipologiaSelect option"), function() {
						if($(this).attr("name") == $("#ambitoSelect").val())
							$(this).show();
						else $(this).hide();
					});
					$("#tipologiaSelect").selectpicker('deselectAll');
					$("#tipologiaSelect").selectpicker("refresh");
				}

				//mostra nasconde le tipologia al doc ready se ambito non Ã¨ null
				function initTipologia() {
					$.each($("#tipologiaSelect option"), function() {
						if($(this).attr("name") == $("#ambitoSelect").val())
							$(this).show();
						else $(this).hide();
					});
					$("#tipologiaSelect").selectpicker("refresh");
				}

				//sistema la select degli account a cui inviare la comunicazione
				function showHideDestinatari(values) {
					if(values == null) {
						values = ["Commissione ECM", "Osservatori ECM", "Provider", "Referee ECM"];
					}
					console.log(allDestinatari);
					$("#destinatari").empty();
					for(var i = 0 ; i < values.length ; i++) {
						var optgroup = $("<optgroup label='" + values[i] + "'></optgroup>");
						var filteredDestinatari = allDestinatari[values[i]];
						for(var k = 0; k < filteredDestinatari.length; k++) {
							var option = $("<option value='" + filteredDestinatari[k].id + "'>" + filteredDestinatari[k].fullName + ' &lt;'  + filteredDestinatari[k].email + '&gt;' + "</option>");
							optgroup.append(option);
						}
						$("#destinatari").append(optgroup);
					}
				}

			/*]]>*/
			</script>
		</div>
	</div>
</body>
</html>