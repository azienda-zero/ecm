<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity4"
	layout:decorator="fragments/template">
<head lang="it">
</head>
<body>
	<div layout:fragment="content">

		<!--  modale di selezione lookup o nuovo -->
		<div id="scelta-modal" class="modal fade modal-scelta" data-model-index="1" role="dialog">
			<div class="modal-dialog modal-md">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span>
						</button>
						<h4 class="modal-title" id="myModalLabel" th:text="#{label.scelta_modalita}">Scelta modalità</h4>
					</div>
					<div class="modal-body">
						<button type="button" class="btn btn-success btn-scelta btn-first" id="trova_anagrafica" data-toggle="modal" data-target=".modal-lookup"><span class="text-btn-scelta" th:text="#{label.seleziona_anagrafica}">Seleziona anagrafica esistente</span></button>
						<a class="btn btn-success btn-scelta btn-last" id="nuova_anagrafica" href=""><span class="text-btn-scelta" th:text="#{label.inserisci_nuova_anagrafica}">Inserisci nuova anagrafica</span></a>
					</div>
				</div>
			</div>
		</div>

		<!-- finestra modale di lookup delle anagrafiche -->
		<div id="persona-modal" class="modal fade modal-lookup" data-model-index="2" role="dialog">
			<div class="modal-dialog modal-lg">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span>
						</button>
						<h4 class="modal-title" id="myModalLabel2" th:text="#{label.cerca_persona}">Cerca anagrafica</h4>
					</div>
					<div class="modal-body">
						<table id="tabella-modale" class="datatable-responsive-search table table-striped table-bordered dt-responsive nowrap" cellspacing="0" width="100%">
							<thead>
								<tr>
									<th th:text="#{label.codice_fiscale}">Codice fiscale</th>
									<th th:text="#{label.nome}">Nome</th>
									<th th:text="#{label.cognome}">Cognome</th>
									<th></th>
								</tr>
							</thead>
							<tbody>
								<!-- popolata con una request ajax -->
							</tbody>
						</table>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-primary" data-dismiss="modal" th:text="#{label.chiudi}">Chiudi</button>
					</div>
				</div>
			</div>
		</div>


		<div class="row">
			<div class="col-xs-12">

				<div class="x_panel">
					<div class="x_title">
						<h2 th:text="${#messages.msg('label.provider_accreditamento') + ' ' + accreditamentoWrapper.provider.denominazioneLegale + ' (' + accreditamentoWrapper.provider.codiceFiscale + ') ' + #messages.msg('label.tipo_provider') + ' ' + accreditamentoWrapper.provider.tipoOrganizzatore.gruppo}"></h2>
						<div class="pull-right buttons-header">
							<a th:if="${accreditamentoWrapper.canSend}"
									class="btn btn-success pull-right"
									th:text="#{label.invia_domanda}"
									th:href="@{|/accreditamento/${accreditamentoWrapper.accreditamento.id}/provider/${accreditamentoWrapper.provider.id}/send|}"></a>
<<<<<<< HEAD
							<button type="button" class="btn btn-primary pull-right" th:text="#{label.torna_in_visualizzazione}" onclick="switchMode('show')"></button>
=======
							<button type="button" class="btn btn-primary pull-right" th:text="#{label.torna_in_visualizzazione}" onclick="switchMode()"></button>
>>>>>>> branch 'master' of http://gitlab.bo.priv/ecm/it.tredi.ecm.git
						</div>
						<div class="clearfix"></div>
					</div>
				</div>

				<div class="x_panel">
					<div class="x_title">
						<h2 th:text="#{label.accreditamento_titolo(Modifica, ${accreditamentoWrapper.accreditamento.tipoDomanda.nome},${accreditamentoWrapper.accreditamento.stato.nome})}">Provvisorio - bozza</h2>
						<div class="clearfix"></div>
					</div>

					<th:block th:include="accreditamento/accreditamentoFragment :: accreditamento('edit')"></th:block>

				</div>
			</div>
			<script th:inline="javascript">
			/*<![CDATA[*/

			  	var tabSelected = "tab1";
				$('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
					tabSelected = e.target.id;
					console.log(tabSelected);
				});

				function switchMode(mode) {
					var param = "?tab=" + tabSelected;
					var url = [[@{|/accreditamento/${accreditamentoWrapper.accreditamento.id}/|}]] + mode + param;
					location.href = url;
				}

				function setEditURLs(ruolo) {
					$('#nuova_anagrafica').prop('href', [[@{|/accreditamento/${accreditamentoWrapper.accreditamento.id}/provider/${accreditamentoWrapper.provider.id}/persona/new?ruolo=|}]]+ruolo);
					var table = $('#tabella-modale').DataTable();
					table.clear();
					$.get( "/provider/" + [[${accreditamentoWrapper.provider.id}]] + "/anagraficaList", function(data){
						var start = [[@{|/accreditamento/${accreditamentoWrapper.accreditamento.id}/provider/${accreditamentoWrapper.provider.id}/persona/|}]];

						for(item in data){
							var obj = data[item];
							table.row.add([
								obj.codiceFiscale,
								obj.nome,
								obj.cognome,
								'<a class="btn btn-primary btn-lookup" href="' + start + ruolo + '/setAnagrafica?anagraficaId=' + obj.id + '">'+[[#{label.seleziona}]]+'</a>'
							]).draw(false);
						}
					});
				}

				$(document).ready(function() {

					$('a[data-toggle="tab"]').on('click', function (e) {
						// tab selezionata
						var tab = $(e.target).attr('id');

						if (tab == "tab2") {
							// check se la sezione è stata compilata (procede in caso affermativo, nega l'apertura della tab e manda un warn altrimenti)
							// controlla anche se il warning è già aperto e in caso lo anima
							if (![[${accreditamentoWrapper.sezione1Stato}]]) {
								var exists = false;
								//se è già aperto il pnotify chiama l'animate (attention seeker)
						        $(".ui-pnotify-text").each(function() {
						            if ($(this).html() == [[#{message.compilare_tab1}]]) {
						                exists = true;
						                animate($(this).parent().parent());
						            }
						        });
								//altrimenti apre un nuovo pnotify
						        if (!exists) {
						        	sendNotifyStatic([[#{message.warning}]], [[#{message.compilare_tab1}]], "warning");
						        }
						        return false;
							} else {
								//check se non sia stato inserito alcun responsabile (altrimenti warn legale non modificabile)
								if ([[${accreditamentoWrapper.responsabileSegreteria == null} and
								      ${accreditamentoWrapper.responsabileAmministrativo == null} and
								      ${accreditamentoWrapper.responsabileSistemaInformatico == null} and
								      ${accreditamentoWrapper.responsabileQualita == null}]]) {
									var exists = false;
							        $(".ui-pnotify-text").each(function() {
							            if ($(this).html() == [[#{message.legale_non_piu_modificabile}]]) {
							                exists = true;
							                animate($(this).parent().parent());
							            }
							        });
							        if (!exists) {
							        	sendNotifyStatic([[#{message.warning}]], [[#{message.legale_non_piu_modificabile}]], "warning");
							        }
								}
								//in ogni caso non è bloccante
								return true;
							}
						}
						if (tab == "tab3") {
							if([[${accreditamentoWrapper.comitatoScientificoErrorMessage != '' && accreditamentoWrapper.comitatoScientificoErrorMessage != null}]]) {
								var exists = false;
						        $(".ui-pnotify-text").each(function() {
						            if ($(this).html() == [[#{${(accreditamentoWrapper.comitatoScientificoErrorMessage != '' and accreditamentoWrapper.comitatoScientificoErrorMessage != null) ? accreditamentoWrapper.comitatoScientificoErrorMessage : 'message.errore_eccezione'}}]]) {
						                exists = true;
						                animate($(this).parent().parent());
						            }
						        });
						        if (!exists) {
						        	sendNotifyStatic([[#{message.warning}]], [[#{${(accreditamentoWrapper.comitatoScientificoErrorMessage != '' and accreditamentoWrapper.comitatoScientificoErrorMessage != null) ? accreditamentoWrapper.comitatoScientificoErrorMessage : 'message.errore_eccezione'}}]], "warning");
						        }
						        return false;
							}
							else {
								if (![[${accreditamentoWrapper.sezione2Stato}]]) {
									var exists = false;
							        $(".ui-pnotify-text").each(function() {
							            if ($(this).html() == [[#{message.compilare_tab2}]]) {
							                exists = true;
							                animate($(this).parent().parent());
							            }
							        });
							        if (!exists) {
							        	sendNotifyStatic([[#{message.warning}]], [[#{message.compilare_tab2}]], "warning");
							        }
							        return false;
								}
								else return true;
							}
						}
						if (tab == "tab4") {
							if (![[${accreditamentoWrapper.completa}]]) {
								var exists = false;
						        $(".ui-pnotify-text").each(function() {
						            if ($(this).html() == [[#{message.compilare_altre_tab}]]) {
						                exists = true;
						                animate($(this).parent().parent());
						            }
						        });
						        if (!exists) {
						        	sendNotifyStatic([[#{message.warning}]], [[#{message.compilare_altre_tab}]], "warning");

						        }
						        return false;
							}
							else return true;
						}
					});
				});
			/*]]>*/
			</script>
		</div>
	</div>
</body>
</html>